<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Video Search Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <style>
    /* Base styling */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0 10px;  /* Add horizontal padding */
      background-color: #f8f9fa;
      color: #343a40;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      line-height: 1.4;
      box-sizing: border-box;
    }
    *, *::before, *::after {
      box-sizing: inherit;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    /* Header */
    .header {
      width: 100%;
      max-width: 600px;
      padding: 20px 10px;
      text-align: center;
    }
    .logo {
      max-height: 50px;
      height: auto;
      width: auto;
      margin-bottom: 10px;
    }
    .title {
      font-size: 1.5rem;
      margin: 0;
      color: #007bff;
    }
    /* Search container */
    .search-container {
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
      background-color: #ffffff;
      padding: 20px 10px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      flex: 1 0 auto;
      display: flex;
      flex-direction: column;
    }
    .search-box, .control {
      padding: 14px 12px;
      margin: 8px 0;
      border: 1px solid #ced4da;
      border-radius: 6px;
      width: 100%;
      font-size: 1rem;
    }
    .search-button {
      padding: 14px;
      margin-top: 8px;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color .3s;
      width: 100%;
    }
    .search-button:hover {
      background-color: #0056b3;
    }
    /* Flex containers for filters */
    .flex-row {
      display: flex;
      flex-direction: column;
    }
    .flex-column {
      width: 100%;
    }
    .label {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    /* Results */
    .results {
      width: 100%;
      margin-top: 20px;
    }
    .result-item {
      background: #fff;
      border: 1px solid #ced4da;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 12px;
      transition: transform .2s;
    }
    .result-item:hover {
      transform: scale(1.01);
    }
    .video-embed {
      width: 100%;
      height: auto;
      max-height: 300px;
      margin-top: 10px;
    }
    /* Controls inside results */
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 8px;
    }
    .vote-container, .add-btn, .vote-btn, .delete-button {
      min-width: 44px;
      min-height: 44px;
      font-size: 1rem;
    }
    .add-btn {
      background:#28a745;
      color:#fff;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-btn:hover {
      background:#218838;
    }
    .vote-btn {
      background:#f2f2f2;
      color:#343a40;
      padding:10px;
      border: none;
      border-radius:4px;
    }
    .vote-btn:hover {
      background:#e2e6ea;
    }
    .vote-btn:disabled {
      background:#d6dadc;
      color:#adb5bd;
      cursor:not-allowed;
    }
    .delete-button {
      background:#dc3545;
      color:#fff;
      padding:10px;
      border:none;
      border-radius:4px;
    }
    .delete-button:hover {
      background:#c82333;
    }
    .delete-button:disabled {
      background:#6c757d;
      cursor:not-allowed;
    }
    .vote-value {
      margin-left:8px;
      font-size: 1rem;
    }
    .no-results-message {
      text-align:center;
      color:#6c757d;
      font-size:1.1rem;
      margin-top:20px;
    }
    /* Pagination */
    .pagination {
      text-align:center;
      margin:20px 0;
    }
    .pagination button {
      padding:10px 16px;
      margin:5px;
      border:none;
      border-radius:6px;
      background:#007bff;
      color:#fff;
      font-size:1rem;
      cursor:pointer;
      transition:.3s;
    }
    .pagination button:hover {
      background:#0056b3;
    }
    .pagination .disabled {
      background:#ced4da;
      cursor:not-allowed;
      color:#6c757d;
    }
    /* Custom word-length inputs */
    #customWordLengthInputs {
      display: none;
      flex-direction: column;
      width: 100%;
    }
    /* Footer */
    footer {
      text-align:center;
      margin:20px 0;
      font-size:0.9rem;
      color:#6c757d;
    }
    /* Larger screens adjustments */
    @media (min-width: 600px) {
      .flex-row {
        flex-direction: row;
        justify-content: space-between;
      }
      .flex-column {
        width: calc(33% - 10px);
      }
      .search-button {
        width: auto;
        align-self: flex-start;
      }
      .title {
        font-size: 2rem;
      }
      .search-container {
        padding: 20px; /* slightly more padding on larger screens */
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="https://www.golingoapp.com/">
      <img src="site-logo.png" alt="Logo" class="logo">
    </a>
    <h1 class="title">Let's Learn Language Together with AI</h1>
  </div>

  <div class="search-container" id="searchContainer">
    <input type="text" id="searchQuery" class="search-box" placeholder="Search...">

    <div class="flex-row">
      <div class="flex-column">
        <span class="label">Language</span>
        <input list="languageList" id="languageSelect" class="control" placeholder="Any">
        <datalist id="languageList">
          <option value="Any">
          <option value="English">
          <option value="Vietnamese">
          <option value="Spanish">
          <option value="Chinese">
          <option value="Japanese">
          <option value="French">
          <option value="Russian">
          <option value="Arabic">
          <option value="Hindi">
          <option value="German">
          <option value="Korean">
          <option value="Italian">
        </datalist>
      </div>

      <div class="flex-column">
        <span class="label">Type</span>
        <select id="typeSelect" class="control">
          <option value="any">Any</option>
          <option value="sentence">Sentence</option>
          <option value="movie">Movie</option>
        </select>
      </div>

      <div class="flex-column">
        <span class="label">Word Length</span>
        <select id="wordLengthSelect" class="control">
          <option value="any">Any</option>
          <option value="short">Short</option>
          <option value="medium">Medium</option>
          <option value="long">Long</option>
          <option value="custom">Custom</option>
        </select>
        <div id="customWordLengthInputs">
          <input type="number" id="wordLengthMin" class="control" placeholder="Min" min="1" style="margin-bottom:8px;">
          <input type="number" id="wordLengthMax" class="control" placeholder="Max" min="1">
        </div>
      </div>
    </div>

    <button class="search-button" onclick="searchMovies()">Search</button>

    <div id="results" class="results"></div>
    <div id="pagination" class="pagination"></div>
  </div>

  <footer>Â© 2025 GoLingoApp</footer>

  <script>
    let currentPage = 1,
        itemsPerPage = 5,
        allResults = [],
        userName = null;

    const allowedUsers = ["charley@gmail.com","xin@gmail.com"];
    const langCodeMap = {
      Any:'any', English:'en', Vietnamese:'vi', Spanish:'es',
      Chinese:'zh-CHS', Japanese:'ja', French:'fr', Russian:'ru',
      Arabic:'ar', Hindi:'hi', German:'de', Korean:'ko', Italian:'it'
    };

    document.getElementById('searchQuery')
      .addEventListener('keypress', e => { if (e.key === 'Enter') searchMovies(); });

    document.getElementById('wordLengthSelect')
      .addEventListener('change', e => {
        document.getElementById('customWordLengthInputs')
          .style.display = e.target.value === 'custom' ? 'flex' : 'none';
      });

    function scrollToTop(){
      document.getElementById('searchContainer')
        .scrollIntoView({ behavior: 'smooth' });
    }

    function searchMovies(){
      const q = document.getElementById('searchQuery').value.trim();
      // You can choose to prevent empty queries:
      // if (!q) return;
      const langIn = document.getElementById('languageSelect').value.trim();
      const lang = langCodeMap[langIn] || 'any';
      const type = document.getElementById('typeSelect').value;
      const wl = document.getElementById('wordLengthSelect').value;
      const payload = { q };

      if (lang !== 'any') payload.lang = lang;
      if (type !== 'any') payload.type = type;

      if (wl !== 'any') {
        if (wl === 'short') payload.word_length_max = 10;
        else if (wl === 'medium') {
          payload.word_length_min = 10;
          payload.word_length_max = 20;
        } else if (wl === 'long') {
          payload.word_length_min = 20;
        } else if (wl === 'custom') {
          const mn = parseInt(document.getElementById('wordLengthMin').value, 10);
          const mx = parseInt(document.getElementById('wordLengthMax').value, 10);
          if (!isNaN(mn) && mn > 0) payload.word_length_min = mn;
          if (!isNaN(mx) && mx > 0) payload.word_length_max = mx;
        }
      }

      fetch('https://jn2vareve4.execute-api.us-east-1.amazonaws.com/prod/querymovie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        allResults = data.body || [];
        currentPage = 1;
        displayResults();
        displayPagination();
        scrollToTop();
      })
      .catch(console.error);
    }

    function displayResults(){
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      const start = (currentPage - 1) * itemsPerPage;
      const slice = allResults.slice(start, start + itemsPerPage);
      if (slice.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results-message"><p>No results found.</p></div>';
        return;
      }

      slice.forEach((item, idx) => {
        const globalIndex = start + idx;  // unique index across all results

        const row = document.createElement('div');
        row.className = 'result-item';

        const content = document.createElement('div');
        content.className = 'result-content';

        const sentenceP = document.createElement('p');
        sentenceP.textContent = item.sentence;
        content.appendChild(sentenceP);

        if (item.url && item.url !== 'NA') {
          let embed = null;
          if (item.url.includes('youtube.com/watch') || item.url.includes('youtu.be')) {
            const videoIdMatch = item.url.match(/(?:v=|\/)([A-Za-z0-9_-]{11})/);
            const videoId = videoIdMatch ? videoIdMatch[1] : null;
            if (videoId) {
              embed = document.createElement('iframe');
              embed.src = 'https://www.youtube.com/embed/' + videoId;
              embed.width = '100%';
              embed.height = '315';
              embed.className = 'video-embed';
              embed.setAttribute('frameborder', '0');
              embed.setAttribute('allow', 'accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
              embed.setAttribute('allowfullscreen', 'true');
            }
          }
          if (!embed) {
            embed = document.createElement('video');
            embed.src = item.url;
            embed.controls = true;
            embed.className = 'video-embed';
          }
          content.appendChild(embed);
        }

        if (item.video_source_name && item.video_source_name !== 'NA' &&
            item.video_source_link && item.video_source_link !== 'NA') {
          const srcLink = document.createElement('a');
          srcLink.href = item.video_source_link;
          srcLink.target = '_blank';
          srcLink.textContent = 'Source: ' + item.video_source_name;
          content.appendChild(document.createElement('br'));
          content.appendChild(srcLink);
        }

        if (item.url && item.url !== 'NA') {
          const upLink = document.createElement('a');
          upLink.href = 'https://vendor.golingoapp.com/';
          upLink.target = '_blank';
          upLink.textContent = 'Upload Your Video';
          content.appendChild(document.createElement('br'));
          content.appendChild(upLink);
        }

        row.appendChild(content);

        const controls = document.createElement('div');
        controls.className = 'controls-row';

        const addBtn = document.createElement('button');
        addBtn.className = 'add-btn';
        addBtn.textContent = 'Add';
        addBtn.id = `add-button-${globalIndex}`;  // NEW unique id
        addBtn.onclick = () => {
          console.log('Added sentence:', item.sentence);
          addBtn.disabled = true;
          addBtn.textContent = 'Added';
          addBtn.dataset.sentence = item.sentence;
        };
        controls.appendChild(addBtn);

        if (item.index_name === 'movies') {
          const vc = document.createElement('div');
          vc.className = 'vote-container';

          const up = document.createElement('button');
          up.className = 'vote-btn';
          up.textContent = 'ðŸ‘';
          up.onclick = () => submitVote(item, 1, up, down, voteSpan);
          vc.appendChild(up);

          const down = document.createElement('button');
          down.className = 'vote-btn';
          down.textContent = 'ðŸ‘Ž';
          down.onclick = () => submitVote(item, -1, up, down, voteSpan);
          vc.appendChild(down);

          const voteSpan = document.createElement('span');
          voteSpan.className = 'vote-value';
          voteSpan.textContent = 'Total votes: ' + (item.vote || 0);
          vc.appendChild(voteSpan);

          controls.appendChild(vc);
        }

        if (allowedUsers.includes(userName)) {
          const del = document.createElement('button');
          del.className = 'delete-button';
          del.textContent = 'Delete';
          del.onclick = () => {
            del.disabled = true;
            fetch('https://jn2vareve4.execute-api.us-east-1.amazonaws.com/prod/deletemovie', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                index_name: item.index_name,
                id: item.id,
                user_name: userName
              })
            })
            .then(r => {
              if (r.ok) del.textContent = 'Deleted';
              else {
                del.disabled = false;
                console.error('Delete failed');
              }
            })
            .catch(err => {
              del.disabled = false;
              console.error(err);
            });
          };
          controls.appendChild(del);
        }

        row.appendChild(controls);
        resultsDiv.appendChild(row);
      });
    }

    function submitVote(item, voteVal, upBtn, downBtn, voteSpan){
      upBtn.disabled = downBtn.disabled = true;
      fetch('https://jn2vareve4.execute-api.us-east-1.amazonaws.com/prod/update-user-vote', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          id: item.id,
          user_name: userName,
          index_name: item.index_name,
          vote: voteVal
        })
      })
      .then(res => {
        upBtn.disabled = downBtn.disabled = false;
        if (res.ok){
          console.log('Vote update succeeded');
        } else {
          console.error('Vote update failed');
        }
      })
      .catch(err => {
        upBtn.disabled = downBtn.disabled = false;
        console.error(err);
      });
    }

    function displayPagination(){
      const p = document.getElementById('pagination');
      p.innerHTML = '';
      const totalPages = Math.ceil(allResults.length / itemsPerPage);
      if (totalPages < 2) return;

      const prev = document.createElement('button');
      prev.textContent = 'Prev';
      prev.onclick = () => {
        if (currentPage > 1){
          currentPage--;
          displayResults();
          displayPagination();
          scrollToTop();
        }
      };
      if (currentPage === 1){
        prev.disabled = true;
        prev.classList.add('disabled');
      }
      p.appendChild(prev);

      const next = document.createElement('button');
      next.textContent = 'Next';
      next.onclick = () => {
        if (currentPage < totalPages){
          currentPage++;
          displayResults();
          displayPagination();
          scrollToTop();
        }
      };
      if (currentPage === totalPages){
        next.disabled = true;
        next.classList.add('disabled');
      }
      p.appendChild(next);
    }

    window.onload = () => {
      const ps = new URLSearchParams(window.location.search);
      const q = ps.get('q'),
            lang = ps.get('lang'),
            type = ps.get('type'),
            wmin = ps.get('word_length_min'),
            wmax = ps.get('word_length_max');

      userName = ps.get('user_name');

      if (q) document.getElementById('searchQuery').value = q;
      if (lang) {
        const nm = Object.keys(langCodeMap)
          .find(k => langCodeMap[k] === lang);
        if (nm) document.getElementById('languageSelect').value = nm;
      }
      if (type) document.getElementById('typeSelect').value = type;
      if (wmin || wmax) {
        document.getElementById('wordLengthSelect').value = 'custom';
        document.getElementById('customWordLengthInputs').style.display = 'flex';
        if (wmin) document.getElementById('wordLengthMin').value = wmin;
        if (wmax) document.getElementById('wordLengthMax').value = wmax;
      }
      if (q) searchMovies();
    };
  </script>
</body>
</html>
